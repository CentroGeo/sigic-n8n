
services:
  traefik:
    image: traefik:v2.11
    restart: unless-stopped
    command:
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik/traefik.yml:/traefik.yml:ro
      - traefik_letsencrypt:/letsencrypt
    labels:
      - "traefik.enable=true"
    networks:
      - sigicnetwork

  oauth2-proxy:
    image: quay.io/oauth2-proxy/oauth2-proxy:v7.6.0
    container_name: oauth2-proxy
    restart: unless-stopped
    env_file:
      - .env
    command:
      - --provider=oidc
      - --oidc-issuer-url=${KEYCLOAK_ISSUER_URL}
      - --client-id=${OAUTH2_PROXY_CLIENT_ID}
      - --client-secret=${OAUTH2_PROXY_CLIENT_SECRET}
      - --email-domain=*

      # üîê JWT bearer validation
      - --skip-jwt-bearer-tokens=false
      - --pass-authorization-header=true
      - --set-authorization-header=false
      - --pass-access-token=false

      # üö´ SIN cookies / SIN sesiones
      - --cookie-secret=${OAUTH2_PROXY_COOKIE_SECRET}
      - --cookie-expire=0s
      - --cookie-refresh=0s

      # üö® CLAVE: negar TODO por defecto
      - --skip-auth-route=^/oauth2

      # auth_request
      - --http-address=0.0.0.0:4180
      - --reverse-proxy=true
      - --force-json-errors=true

    labels:
      - "traefik.enable=true"

      # ===== Router OAuth2 (login, callback, auth) =====
      - "traefik.http.routers.oauth2.rule=Host(`n8n.cesarbenjamin.net`) && PathPrefix(`/oauth2`)"
      - "traefik.http.routers.oauth2.entrypoints=websecure"
      - "traefik.http.routers.oauth2.tls.certresolver=letsencrypt"
      - "traefik.http.routers.oauth2.service=oauth2"

      - "traefik.http.middlewares.jwt-auth.forwardauth.address=http://oauth2-proxy:4180/oauth2/auth"
      - "traefik.http.middlewares.jwt-auth.forwardauth.trustForwardHeader=true"
      - "traefik.http.middlewares.jwt-auth.forwardauth.authResponseHeaders=Authorization"

      # Service
      - "traefik.http.services.oauth2.loadbalancer.server.port=4180"

    networks:
      - sigicnetwork

  n8n:
    image: n8nio/n8n:latest
    restart: unless-stopped
    environment:
      TZ: ${TZ}
      N8N_ENCRYPTION_KEY: ${N8N_ENCRYPTION_KEY}

      # HTTP / Public
      N8N_HOST: ${N8N_HOST}
      WEBHOOK_URL: ${N8N_WEBHOOK_URL}
      N8N_SECURE_COOKIE: ${N8N_SECURE_COOKIE}
      N8N_PROTOCOL: ${N8N_PROTOCOL}
      N8N_TRUST_PROXY: ${N8N_TRUST_PROXY}
      N8N_PROXY_HOPS: 1

      # Database (n8n espera DB_*, t√∫ traduces)
      DB_TYPE: ${N8N_DB_TYPE}
      DB_POSTGRESDB_HOST: ${N8N_DB_HOST}
      DB_POSTGRESDB_PORT: ${N8N_DB_PORT}
      DB_POSTGRESDB_DATABASE: ${N8N_DB_NAME}
      DB_POSTGRESDB_USER: ${N8N_DB_USER}
      DB_POSTGRESDB_PASSWORD: ${N8N_DB_PASSWORD}

      # Queue / Redis
      OFFLOAD_MANUAL_EXECUTIONS_TO_WORKERS: "false"
      EXECUTIONS_MODE: queue
      QUEUE_BULL_REDIS_HOST: ${N8N_REDIS_HOST:-redis}
      QUEUE_BULL_REDIS_PORT: ${N8N_REDIS_PORT:-6379}
      QUEUE_BULL_REDIS_DB: 1
      QUEUE_BULL_QUEUE_NAME: jobs

      # Runners
      N8N_RUNNERS_ENABLED: "true"
      N8N_RUNNERS_MODE: external
      N8N_RUNNERS_AUTH_TOKEN: ${N8N_RUNNERS_AUTH_TOKEN}

      N8N_RUNNERS_BROKER_HOST: n8n
      N8N_RUNNERS_BROKER_PORT: 5679

    depends_on:
      - postgres
      - redis
    volumes:
      - n8n_data:/home/node/.n8n
    labels:
      - "traefik.enable=true"

      # ===== API DOCS (PUBLICO) =====
      - "traefik.http.routers.n8n-api-docs.rule=Host(`n8n.cesarbenjamin.net`) && PathPrefix(`/api/v1/docs`)"
      - "traefik.http.routers.n8n-api-docs.entrypoints=websecure"
      - "traefik.http.routers.n8n-api-docs.tls.certresolver=letsencrypt"
      - "traefik.http.routers.n8n-api-docs.service=n8n"
      - "traefik.http.routers.n8n-api-docs.priority=200"

      # ===== API PROTEGIDA (JWT) =====
      - "traefik.http.routers.n8n-api.rule=Host(`n8n.cesarbenjamin.net`) && PathPrefix(`/api`)"
      - "traefik.http.routers.n8n-api.entrypoints=websecure"
      - "traefik.http.routers.n8n-api.tls.certresolver=letsencrypt"
      - "traefik.http.routers.n8n-api.middlewares=jwt-auth@docker"
      - "traefik.http.routers.n8n-api.service=n8n"
      - "traefik.http.routers.n8n-api.priority=100"

      # ===== WEBHOOKS (JWT) =====
      - "traefik.http.routers.n8n-webhook.rule=Host(`n8n.cesarbenjamin.net`) && PathPrefix(`/webhook`)"
      - "traefik.http.routers.n8n-webhook.entrypoints=websecure"
      - "traefik.http.routers.n8n-webhook.tls.certresolver=letsencrypt"
      - "traefik.http.routers.n8n-webhook.middlewares=jwt-auth@docker"
      - "traefik.http.routers.n8n-webhook.service=n8n"
      - "traefik.http.routers.n8n-webhook.priority=100"

      # ===== UI (PUBLICA) =====
      - "traefik.http.routers.n8n-ui.rule=Host(`n8n.cesarbenjamin.net`)"
      - "traefik.http.routers.n8n-ui.entrypoints=websecure"
      - "traefik.http.routers.n8n-ui.tls.certresolver=letsencrypt"
      - "traefik.http.routers.n8n-ui.service=n8n"
      - "traefik.http.routers.n8n-ui.priority=1"

      # ===== SERVICE =====
      - "traefik.http.services.n8n.loadbalancer.server.port=5678"

    networks:
      - sigicnetwork

  n8n-worker:
    image: n8nio/n8n:latest
    restart: unless-stopped
    command: worker

    environment:
      TZ: ${TZ}
      N8N_ENCRYPTION_KEY: ${N8N_ENCRYPTION_KEY}

      N8N_DISABLE_UI: "true"

      EXECUTIONS_MODE: queue
      N8N_WORKER: "true"
      OFFLOAD_MANUAL_EXECUTIONS_TO_WORKERS: "true"

      # Redis
      QUEUE_BULL_REDIS_HOST: ${N8N_REDIS_HOST:-redis}
      QUEUE_BULL_REDIS_PORT: ${N8N_REDIS_PORT:-6379}
      QUEUE_BULL_REDIS_DB: 1
      QUEUE_BULL_QUEUE_NAME: jobs

      # Database (IGUAL que el main)
      DB_TYPE: ${N8N_DB_TYPE}
      DB_POSTGRESDB_HOST: ${N8N_DB_HOST}
      DB_POSTGRESDB_PORT: ${N8N_DB_PORT}
      DB_POSTGRESDB_DATABASE: ${N8N_DB_NAME}
      DB_POSTGRESDB_USER: ${N8N_DB_USER}
      DB_POSTGRESDB_PASSWORD: ${N8N_DB_PASSWORD}

      # Runners
      N8N_RUNNERS_ENABLED: "true"
      N8N_RUNNERS_MODE: external
      N8N_RUNNERS_AUTH_TOKEN: ${N8N_RUNNERS_AUTH_TOKEN}
      N8N_RUNNERS_BROKER_LISTEN_ADDRESS: 0.0.0.0

      N8N_RUNNERS_BROKER_HOST: n8n
      N8N_RUNNERS_BROKER_PORT: 5679

    depends_on:
      - postgres
      - redis
    networks:
      - sigicnetwork

  task-runners-worker:
    image: n8nio/runners:2.3.5
    environment:
      N8N_RUNNERS_AUTH_TOKEN: ${N8N_RUNNERS_AUTH_TOKEN}
      N8N_RUNNERS_TASK_BROKER_URI: http://n8n-worker:5679
    depends_on:
      - n8n-worker
    networks:
      - sigicnetwork

  task-runners:
    image: n8nio/runners:2.3.5
    environment:
      N8N_RUNNERS_AUTH_TOKEN: ${N8N_RUNNERS_AUTH_TOKEN}
      N8N_RUNNERS_TASK_BROKER_URI: http://n8n:5679
    depends_on:
      - n8n
    networks:
      - sigicnetwork

  redis:
    image: redis:7-alpine
    restart: unless-stopped
    volumes:
      - redis_data:/data
    networks:
      - sigicnetwork

  postgres:
    image: postgres:16
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - sigicnetwork

volumes:
  postgres_data:
  redis_data:
  n8n_data:
  traefik_letsencrypt:

networks:
  sigicnetwork:
    external: true
